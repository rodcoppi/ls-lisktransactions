# Prometheus Alert Rules for Load Testing
groups:
  - name: load-testing-alerts
    rules:
      # High error rate during load testing
      - alert: HighErrorRateDuringLoadTest
        expr: rate(http_requests_failed_total[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: critical
          service: load-testing
        annotations:
          summary: "High error rate detected during load test"
          description: "Error rate is {{ $value | humanizePercentage }} which is above the 5% threshold"

      # High response time during load testing
      - alert: HighResponseTimeDuringLoadTest
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          service: load-testing
        annotations:
          summary: "High response time detected during load test"
          description: "95th percentile response time is {{ $value }}s which is above 500ms threshold"

      # Critical response time threshold
      - alert: CriticalResponseTimeDuringLoadTest
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2.0
        for: 2m
        labels:
          severity: critical
          service: load-testing
        annotations:
          summary: "Critical response time detected during load test"
          description: "95th percentile response time is {{ $value }}s which is above 2s critical threshold"

      # Low throughput during load testing
      - alert: LowThroughputDuringLoadTest
        expr: rate(http_requests_total[5m]) < 100
        for: 5m
        labels:
          severity: warning
          service: load-testing
        annotations:
          summary: "Low throughput detected during load test"
          description: "Current throughput is {{ $value }} req/s which is below 100 req/s threshold"

      # Application down during load testing
      - alert: ApplicationDownDuringLoadTest
        expr: up{job="application"} == 0
        for: 1m
        labels:
          severity: critical
          service: load-testing
        annotations:
          summary: "Application is down during load test"
          description: "The application under test is not responding to health checks"

      # Database connection issues
      - alert: DatabaseConnectionIssues
        expr: increase(database_connection_errors_total[5m]) > 10
        for: 2m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection errors during load test"
          description: "{{ $value }} database connection errors in the last 5 minutes"

      # High memory usage on load generators
      - alert: LoadGeneratorHighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: load-testing
        annotations:
          summary: "High memory usage on load generator"
          description: "Memory usage is {{ $value | humanizePercentage }} on instance {{ $labels.instance }}"

      # High CPU usage on load generators
      - alert: LoadGeneratorHighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 90
        for: 5m
        labels:
          severity: warning
          service: load-testing
        annotations:
          summary: "High CPU usage on load generator"
          description: "CPU usage is {{ $value }}% on instance {{ $labels.instance }}"

      # K6 test execution failure
      - alert: K6TestExecutionFailure
        expr: increase(k6_test_failures_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          service: k6
        annotations:
          summary: "K6 test execution failure"
          description: "K6 test has failed {{ $value }} times in the last 5 minutes"

      # Cache hit rate too low
      - alert: LowCacheHitRate
        expr: cache_hit_rate < 0.8
        for: 5m
        labels:
          severity: warning
          service: caching
        annotations:
          summary: "Low cache hit rate during load test"
          description: "Cache hit rate is {{ $value | humanizePercentage }} which is below 80% threshold"

      # Database query time too high
      - alert: HighDatabaseQueryTime
        expr: histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m])) > 0.1
        for: 3m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "High database query time during load test"
          description: "95th percentile database query time is {{ $value }}s which is above 100ms threshold"

      # Connection pool exhaustion
      - alert: DatabaseConnectionPoolExhaustion
        expr: database_connections_active / database_connections_max > 0.9
        for: 2m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "Database connection pool usage is {{ $value | humanizePercentage }}"

      # Load test duration exceeded
      - alert: LoadTestDurationExceeded
        expr: time() - k6_test_start_timestamp > 7200 # 2 hours
        for: 1m
        labels:
          severity: warning
          service: load-testing
        annotations:
          summary: "Load test duration exceeded expected time"
          description: "Current load test has been running for more than 2 hours"

      # Prometheus scrape failures
      - alert: PrometheusScrapingFailures
        expr: up == 0
        for: 2m
        labels:
          severity: warning
          service: monitoring
        annotations:
          summary: "Prometheus scraping failure"
          description: "Prometheus failed to scrape {{ $labels.job }} on {{ $labels.instance }}"

      # SLA violation detection
      - alert: SLAViolationDetected
        expr: |
          (
            histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 0.2
            or
            rate(http_requests_failed_total[5m]) / rate(http_requests_total[5m]) > 0.001
            or 
            cache_hit_rate < 0.9
          )
        for: 3m
        labels:
          severity: critical
          service: sla
        annotations:
          summary: "SLA violation detected during load test"
          description: "One or more SLA thresholds have been breached"

  - name: infrastructure-alerts
    rules:
      # Disk space running low on load test infrastructure
      - alert: LoadTestInfrastructureDiskSpaceLow
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Low disk space on load test infrastructure"
          description: "Disk space is {{ $value | humanizePercentage }} on {{ $labels.instance }}"

      # Container restart during load test
      - alert: ContainerRestartDuringLoadTest
        expr: increase(container_spec_memory_limit_bytes[5m]) > 0
        for: 1m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Container restarted during load test"
          description: "Container {{ $labels.name }} has been restarted"

      # Network issues during load testing
      - alert: NetworkIssuesDuringLoadTest
        expr: rate(node_network_receive_errs_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "Network errors detected during load test"
          description: "Network error rate is {{ $value }} errors/sec on {{ $labels.instance }}"

  - name: business-logic-alerts
    rules:
      # Throughput below business requirements
      - alert: ThroughputBelowBusinessRequirements
        expr: rate(http_requests_total[5m]) < 1000 # Less than 1000 req/s
        for: 10m
        labels:
          severity: critical
          service: business
        annotations:
          summary: "Throughput below business requirements"
          description: "Current throughput {{ $value }} req/s is below business requirement of 1000 req/s"

      # Concurrent users below target
      - alert: ConcurrentUsersBelowTarget
        expr: k6_vus_current < 5000 # Less than 5000 concurrent users
        for: 5m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "Concurrent users below target"
          description: "Current VUs {{ $value }} is below target of 5000 users"

      # Data processing lag
      - alert: DataProcessingLag
        expr: data_processing_lag_seconds > 300 # More than 5 minutes lag
        for: 3m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "Data processing lag detected"
          description: "Data processing lag is {{ $value }}s which exceeds 5 minutes"
